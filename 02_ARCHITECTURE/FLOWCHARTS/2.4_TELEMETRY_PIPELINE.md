# 2.4 Telemetry Pipeline Architecture
## Data Flow: Engine → WebSocket → Cache → Frontend

**Node ID:** 2.4
**Category:** Backend
**CR Impact:** Phase 3 Real-time Data
**Status:** CREATED
**Version:** 1.0
**Date:** 2026-01-27

---

## Purpose

This document defines the complete telemetry data pipeline from the CIA-SIE-PURE trading engine through to the MCI dashboard display.

---

## Flow Diagram

```mermaid
flowchart TD
    subgraph ENGINE["CIA-SIE-PURE Engine"]
        A[Trading Engine] --> B[Position Updates]
        A --> C[Order Updates]
        A --> D[Market Data]
        A --> E[System Health]
    end

    subgraph BACKEND["MCI Backend"]
        B & C & D & E --> F[Telemetry Routes]
        F --> G[Data Aggregation]
        G --> H{Delivery Method}
        H -->|Polling| I[REST Endpoints]
        H -->|Real-time| J[WebSocket Server]
    end

    subgraph TRANSPORT["Data Transport"]
        I --> K[HTTP Response]
        J --> L[WSS Frame]
    end

    subgraph FRONTEND["MCI Frontend"]
        K --> M[Fetch Request]
        L --> N[WebSocket Client]
        M & N --> O[telemetryStore]
        O --> P[Component Re-render]
    end

    subgraph DASHBOARD["Telemetry Dashboard"]
        P --> Q[PositionsPanel]
        P --> R[OrdersPanel]
        P --> S[AccountPanel]
        P --> T[SystemHealthPanel]
        P --> U[MarketDataPanel]
        P --> V[ActivityLogPanel]
    end

    style ENGINE fill:#e3f2fd
    style BACKEND fill:#fff3e0
    style TRANSPORT fill:#e8f5e9
    style FRONTEND fill:#f3e5f5
    style DASHBOARD fill:#fce4ec
```

---

## Sequence Diagram

```mermaid
sequenceDiagram
    participant Engine as CIA-SIE-PURE
    participant WS as WebSocket Server
    participant Client as WS Client
    participant Store as telemetryStore
    participant Panel as Dashboard Panel

    Note over Engine,Panel: Connection Establishment
    Client->>WS: Connect
    WS-->>Client: Connection ACK
    Client->>Store: setConnected(true)
    Store-->>Panel: isConnected = true

    Note over Engine,Panel: Real-time Data Flow
    loop Every 1 second
        Engine->>WS: Position Update
        WS->>Client: Push Data
        Client->>Store: updatePositions()
        Store-->>Panel: Re-render
    end

    loop Every 5 seconds
        Engine->>WS: System Health
        WS->>Client: Push Data
        Client->>Store: updateHealth()
        Store-->>Panel: Re-render
    end

    Note over Engine,Panel: Polling Fallback
    alt WebSocket Unavailable
        Client->>Client: Start Polling
        loop Every 2 seconds
            Client->>WS: GET /api/telemetry/snapshot
            WS-->>Client: JSON Response
            Client->>Store: updateAll()
        end
    end
```

---

## Data Types

```mermaid
classDiagram
    class Position {
        +string symbol
        +number qty
        +string side
        +number entryPrice
        +number currentPrice
        +number unrealizedPL
        +number unrealizedPLPercent
        +number marketValue
    }

    class Order {
        +string id
        +string symbol
        +string side
        +string type
        +number qty
        +number filledQty
        +number price
        +string status
        +number createdAt
        +number filledAt
    }

    class AccountMetrics {
        +number equity
        +number cash
        +number buyingPower
        +number portfolioValue
        +number dayPL
        +number dayPLPercent
        +number totalPL
        +number totalPLPercent
    }

    class SystemHealth {
        +number cpu
        +number memory
        +number latency
        +number uptime
        +number lastHeartbeat
        +string status
    }

    class MarketData {
        +string symbol
        +number price
        +number change
        +number changePercent
        +number volume
        +number high
        +number low
        +number open
        +number timestamp
    }
```

---

## API Endpoints

| Endpoint | Method | Purpose | Update Frequency |
|----------|--------|---------|------------------|
| `/api/telemetry/positions` | GET | Current positions | 1s |
| `/api/telemetry/orders` | GET | Active/recent orders | 2s |
| `/api/telemetry/account` | GET | Account metrics | 5s |
| `/api/telemetry/health` | GET | System health | 5s |
| `/api/telemetry/market` | GET | Market data | 1s |
| `/api/telemetry/market/:symbol` | GET | Single symbol data | 1s |
| `/api/telemetry/snapshot` | GET | Complete snapshot | On demand |

---

## WebSocket Events

| Event | Direction | Payload | Purpose |
|-------|-----------|---------|---------|
| `connect` | Client→Server | - | Establish connection |
| `disconnect` | Client→Server | - | Close connection |
| `positions` | Server→Client | Position[] | Position updates |
| `orders` | Server→Client | Order[] | Order updates |
| `account` | Server→Client | AccountMetrics | Account updates |
| `health` | Server→Client | SystemHealth | Health updates |
| `market` | Server→Client | MarketData[] | Market updates |
| `activity` | Server→Client | ActivityLog[] | Activity log |

---

## Component Mapping

| Component | File | Data Source |
|-----------|------|-------------|
| TelemetryDashboard | `src/client/components/phase3/TelemetryDashboard.tsx` | Orchestrator |
| PositionsPanel | `src/client/components/phase3/PositionsPanel.tsx` | positions |
| OrdersPanel | `src/client/components/phase3/OrdersPanel.tsx` | orders |
| AccountPanel | `src/client/components/phase3/AccountPanel.tsx` | account |
| SystemHealthPanel | `src/client/components/phase3/SystemHealthPanel.tsx` | health |
| MarketDataPanel | `src/client/components/phase3/MarketDataPanel.tsx` | market |
| ActivityLogPanel | `src/client/components/phase3/ActivityLogPanel.tsx` | activity |
| telemetryStore | `src/client/stores/telemetryStore.ts` | All data |
| telemetry route | `src/server/routes/telemetry.ts` | Data source |

---

## Data Flow State

```mermaid
stateDiagram-v2
    [*] --> Disconnected: Phase 3 Entry
    Disconnected --> Connecting: Initiate Connection
    Connecting --> Connected: WS Handshake Success
    Connecting --> Disconnected: WS Handshake Failed
    Connected --> Streaming: Data Flowing
    Streaming --> Connected: Temporary Pause
    Connected --> Reconnecting: Connection Lost
    Reconnecting --> Connected: Reconnected
    Reconnecting --> Disconnected: Max Retries
    Connected --> Disconnected: User Closes
    Disconnected --> [*]: Phase 4 Entry
```

---

## Performance Requirements

| Metric | Target | Rationale |
|--------|--------|-----------|
| Latency (Position Update) | < 100ms | Real-time trading awareness |
| Latency (Market Data) | < 500ms | Acceptable for monitoring |
| Reconnection Time | < 5s | Minimize blind periods |
| Memory Usage | < 50MB | Dashboard efficiency |
| Update Rate | 1-5s | Balance freshness vs. load |

---

## Error Handling (CR-003)

| Scenario | WHAT | WHY | HOW |
|----------|------|-----|-----|
| WebSocket Disconnect | Connection lost | Network issue or server restart | Auto-reconnect with backoff |
| Stale Data | Data not updating | Stream interrupted | Display warning, retry |
| Parse Error | Invalid data received | Schema mismatch | Log error, skip update |
| Server Overload | Slow updates | High system load | Display degraded status |

---

## Integration Points

| From | To | Protocol | Purpose |
|------|-----|----------|---------|
| CIA-SIE-PURE | MCI Backend | Internal | Trading data |
| MCI Backend | telemetryStore | WSS/HTTP | Data delivery |
| telemetryStore | Dashboard Panels | Zustand | State distribution |

---

*Document ID: FLOW-2.4-TELEMETRY | Layer 2 Architecture | MCI Project*
