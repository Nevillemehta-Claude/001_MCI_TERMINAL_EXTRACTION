# 2.13 Data Flow Lifecycle Architecture
## Complete DFD: Broker → Engine → MCI → Dashboard

**Node ID:** 2.13
**Category:** Integration
**CR Impact:** End-to-End Data Flow, INV-006 (Input Sanitization)
**Status:** UPDATED
**Version:** 1.1
**Date:** 2026-01-28

---

## Purpose

This document defines the complete data flow lifecycle from external broker APIs through the CIA-SIE-PURE trading engine to the MCI dashboard display, showing all transformation and storage points.

---

## End-to-End Data Flow

```mermaid
flowchart LR
    subgraph EXTERNAL["External Systems"]
        B1[Zerodha Kite API]
        B2[ICICI Direct API]
        B3[HDFC Sky API]
        B4[Kotak Neo API]
        M[NSE/BSE Market Data]
    end

    subgraph ENGINE["CIA-SIE-PURE Engine"]
        E1[Broker Connector]
        E2[Order Manager]
        E3[Position Tracker]
        E4[Market Data Handler]
        E5[Event Bus]
    end

    subgraph MCI_BACKEND["MCI Backend"]
        S1[Kite Service]
        S2[Telemetry Routes]
        S3[WebSocket Server]
        S4[Data Cache]
    end

    subgraph MCI_FRONTEND["MCI Frontend"]
        F1[WebSocket Client]
        F2[telemetryStore]
        F3[Dashboard Panels]
    end

    B1 & B2 & B3 & B4 --> E1
    M --> E4
    E1 --> E2 & E3
    E2 & E3 & E4 --> E5
    E5 --> S1
    S1 --> S2 & S3
    S2 --> S4
    S3 --> F1
    S4 --> S2
    F1 --> F2
    F2 --> F3

    style EXTERNAL fill:#e3f2fd
    style ENGINE fill:#fff3e0
    style MCI_BACKEND fill:#e8f5e9
    style MCI_FRONTEND fill:#f3e5f5
```

---

## Data Flow Diagram (Level 0 - Context)

```mermaid
flowchart TD
    subgraph CONTEXT["System Context"]
        USER((Operator))
        MCI[MCI System]
        BROKER((Broker APIs))
        ENGINE((CIA-SIE-PURE))
    end

    USER -->|Commands| MCI
    MCI -->|Display| USER
    BROKER -->|Market Data, Order Status| ENGINE
    ENGINE -->|Orders| BROKER
    ENGINE -->|Telemetry| MCI
    MCI -->|Control Signals| ENGINE

    style CONTEXT fill:#fafafa
```

---

## Data Flow Diagram (Level 1 - System)

```mermaid
flowchart TD
    subgraph MCI_SYSTEM["MCI System Internals"]
        P0[Phase 0: Token Capture]
        P1[Phase 1: Pre-Ignition]
        P2[Phase 2: Ignition]
        P3[Phase 3: Telemetry]
        P4[Phase 4: Shutdown]
        
        DS[(Session Store)]
        DT[(Telemetry Cache)]
    end

    USER((Operator)) -->|Credentials| P0
    P0 -->|Token| DS
    DS -->|Token| P1
    P1 -->|Status| P2
    P2 -->|Connection| P3
    BROKER((Broker)) -->|Data| P3
    P3 -->|Cache| DT
    DT -->|Display| P3
    P3 -->|Display| USER
    P3 -->|Command| P4
    P4 -->|Clear| DS
    P4 -->|Clear| DT

    style MCI_SYSTEM fill:#e8f5e9
```

---

## Data Types and Transformations

```mermaid
graph TD
    subgraph RAW["Raw Data (Broker)"]
        R1[Kite Position Response]
        R2[Kite Order Response]
        R3[Kite Quote Response]
    end

    subgraph TRANSFORM["Transformation Layer"]
        T1[Normalize Position]
        T2[Normalize Order]
        T3[Normalize Quote]
    end

    subgraph NORMALIZED["Normalized Data (MCI)"]
        N1[Position Type]
        N2[Order Type]
        N3[MarketData Type]
    end

    subgraph DISPLAY["Display Data"]
        D1[PositionsPanel Props]
        D2[OrdersPanel Props]
        D3[MarketDataPanel Props]
    end

    R1 --> T1 --> N1 --> D1
    R2 --> T2 --> N2 --> D2
    R3 --> T3 --> N3 --> D3

    style RAW fill:#ffcdd2
    style TRANSFORM fill:#fff3e0
    style NORMALIZED fill:#e8f5e9
    style DISPLAY fill:#e3f2fd
```

---

## Data Lifecycle Stages

| Stage | Location | Data State | Retention |
|-------|----------|------------|-----------|
| **Capture** | Broker API | Raw JSON | Transient |
| **Transform** | MCI Backend | Normalized | Transient |
| **Cache** | Server Memory | Indexed | Session |
| **Transport** | WebSocket | Serialized | Transient |
| **Store** | Zustand Store | Reactive | Session |
| **Display** | React Component | Rendered | Frame |

---

## Token Data Flow (CR-001, CR-004)

```mermaid
sequenceDiagram
    participant User
    participant Form as TokenCaptureForm
    participant Store as tokenStore
    participant API as /api/auth
    participant Kite as Kite API

    User->>Form: Enter credentials
    Form->>API: POST credentials
    API->>Kite: Generate session
    Kite-->>API: Access token
    API->>API: Calculate expiry (6 AM IST)
    API-->>Form: Token + expiry
    Form->>Store: setAccessToken()
    Store->>Store: Persist to sessionStorage
    
    loop Every second
        Store->>Store: Check expiry
        alt Token valid
            Store-->>Form: Display countdown
        else Token expired
            Store->>Store: Clear token
            Store-->>User: Redirect to Phase 0
        end
    end
```

---

## Position Data Flow

```mermaid
sequenceDiagram
    participant Kite as Kite API
    participant Engine as CIA-SIE-PURE
    participant Backend as MCI Backend
    participant WS as WebSocket
    participant Store as telemetryStore
    participant Panel as PositionsPanel

    loop Every 1 second
        Engine->>Kite: Get positions
        Kite-->>Engine: Raw positions
        Engine->>Engine: Track P&L
        Engine->>Backend: Position update
        Backend->>Backend: Normalize data
        Backend->>Backend: Cache update
        Backend->>WS: positions:update event
        WS->>Store: updatePositions()
        Store->>Panel: Re-render
    end
```

---

## Order Data Flow

```mermaid
sequenceDiagram
    participant Kite as Kite API
    participant Engine as CIA-SIE-PURE
    participant Backend as MCI Backend
    participant WS as WebSocket
    participant Store as telemetryStore
    participant Panel as OrdersPanel

    Note over Engine: Order placed by CIA-SIE-PURE
    Engine->>Kite: Place order
    Kite-->>Engine: Order ID
    
    loop Until filled/cancelled
        Kite-->>Engine: Order status update
        Engine->>Backend: Order update
        Backend->>WS: orders:update event
        WS->>Store: updateOrder()
        Store->>Panel: Re-render
    end
```

---

## Market Data Flow

```mermaid
sequenceDiagram
    participant Exchange as NSE/BSE
    participant Kite as Kite API
    participant Backend as MCI Backend
    participant WS as WebSocket
    participant Store as telemetryStore
    participant Panel as MarketDataPanel

    loop Every 1 second
        Exchange->>Kite: Tick data
        Kite->>Backend: Quote update
        Backend->>Backend: Aggregate symbols
        Backend->>WS: market:update event
        WS->>Store: updateMarketData()
        Store->>Panel: Re-render
    end
```

---

## Shutdown Data Flow (CR-002)

```mermaid
sequenceDiagram
    participant User
    participant Panel as ShutdownPanel
    participant Store as shutdownStore
    participant API as /api/shutdown
    participant Engine as CIA-SIE-PURE
    participant Kite as Kite API

    User->>Panel: Initiate shutdown
    Panel->>Store: setPhase('initiating')
    Panel->>API: POST /shutdown

    rect rgb(227, 242, 253)
        Note right of API: Step 1
        API->>Engine: cancelAllOrders()
        Engine->>Kite: Cancel orders
        Kite-->>Engine: Confirmed
        API-->>Store: Step 1 complete
    end

    rect rgb(255, 243, 224)
        Note right of API: Step 2
        API->>Engine: closeAllPositions()
        Engine->>Kite: Close positions
        Kite-->>Engine: Confirmed
        API-->>Store: Step 2 complete
    end

    rect rgb(232, 245, 233)
        Note right of API: Step 3
        API->>Engine: disconnect()
        Engine->>Kite: Logout
        API-->>Store: Step 3 complete
    end

    rect rgb(243, 229, 245)
        Note right of API: Step 4
        API->>API: Close WebSockets
        API-->>Store: Step 4 complete
    end

    rect rgb(252, 228, 236)
        Note right of API: Step 5
        Store->>Store: Clear all stores
        API-->>Store: Step 5 complete
    end

    rect rgb(225, 245, 254)
        Note right of API: Step 6
        API->>API: Log shutdown
        API-->>Panel: Shutdown complete
        Panel-->>User: Return to Phase 0
    end
```

---

## Data Storage Points

| Store | Type | Scope | Data | Cleared On |
|-------|------|-------|------|------------|
| `tokenStore` | Zustand + localStorage | Daily (INV-001) | Credentials, token, expiry | Expiry (6:00 AM IST), manual clear |
| `scannerStore` | Zustand | Session | Check results | Phase transition |
| `ignitionStore` | Zustand + sessionStorage | Session | Backend, phase | Shutdown |
| `telemetryStore` | Zustand | Session | Positions, orders, account, health | Shutdown |
| `shutdownStore` | Zustand | Session | Steps, progress | Complete |
| Server Cache | In-memory | Request | Telemetry snapshot | Server restart |

---

## Data Validation Points

| Point | Validation | Failure Action |
|-------|------------|----------------|
| Token Capture | Kite API validates | Show CR-003 error |
| Token Usage | Check expiry (CR-004) | Redirect to Phase 0 |
| Scan Checks | 12-point validation | Block ignition |
| Ignition | Backend availability | Show CR-003 error |
| Telemetry | Schema validation | Log, skip update |
| Shutdown | Step completion | Retry or force |

---

## INV-006: Input Sanitization Boundaries

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DATA INGRESS BOUNDARIES                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   USER INPUT                                                            │
│   ══════════                                                            │
│   ┌──────────────┐                                                      │
│   │ Form Fields  │ ─────→ [SANITIZE #1] ─────→ tokenStore               │
│   │ (may have    │       sanitizeKiteCredentials()                      │
│   │  whitespace) │                                                      │
│   └──────────────┘                                                      │
│                                                                         │
│   STORAGE REHYDRATION                                                   │
│   ═══════════════════                                                   │
│   ┌──────────────┐                                                      │
│   │ localStorage │ ─────→ [SANITIZE #2] ─────→ tokenStore (in-memory)  │
│   │ (may have    │       sanitizeString() on each field                │
│   │  dirty data) │                                                      │
│   └──────────────┘                                                      │
│                                                                         │
│   API BOUNDARY                                                          │
│   ════════════                                                          │
│   ┌──────────────┐                                                      │
│   │ Request Body │ ─────→ [SANITIZE #3] ─────→ buildKiteAuthHeader()   │
│   │ (never trust │       sanitizeCredentialsFromRequest()              │
│   │  upstream)   │                                                      │
│   └──────────────┘                                                      │
│                                                                         │
│   PROTOCOL CONSTRUCTION                                                 │
│   ══════════════════════                                                │
│   ┌──────────────┐                                                      │
│   │ Sanitized    │ ─────→ [SAFE BUILDER] ────→ "token KEY:TOKEN"       │
│   │ Credentials  │       buildKiteAuthHeader()                         │
│   └──────────────┘       (ensures single space, no injection)          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| Boundary | Sanitizer | Purpose |
|----------|-----------|---------|
| User Input | `sanitizeKiteCredentials()` | Trim whitespace, validate format |
| localStorage | `sanitizeString()` | Never trust persisted data |
| API Request | `sanitizeCredentialsFromRequest()` | Defense in depth |
| Header Build | `buildKiteAuthHeader()` | Safe protocol construction |

---

## Performance Characteristics

| Data Type | Source Rate | Display Rate | Latency Target |
|-----------|-------------|--------------|----------------|
| Positions | 1/sec | 1/sec | < 100ms |
| Orders | On change | Immediate | < 100ms |
| Account | 5/sec | 5/sec | < 200ms |
| Health | 5/sec | 5/sec | < 200ms |
| Market | 1/sec | 1/sec | < 500ms |

---

## Failure Modes

| Failure | Detection | Recovery |
|---------|-----------|----------|
| Broker API down | Scan check, timeout | Retry, show error |
| WebSocket disconnect | Heartbeat miss | Reconnect with backoff |
| Cache overflow | Memory monitor | Evict old data |
| Token expired | Expiry check | Redirect to Phase 0 |
| Parse error | Schema validation | Log, skip, alert |

---

## Integration Points Summary

```
┌─────────────────────────────────────────────────────────────────┐
│                     EXTERNAL BOUNDARY                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Zerodha Kite │  │ ICICI Direct │  │  Other APIs  │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                 │                 │                   │
│         └────────────┬────┴────────────────┘                   │
│                      ▼                                          │
│         ┌────────────────────────┐                             │
│         │    CIA-SIE-PURE        │                             │
│         │    (Trading Engine)     │                             │
│         └───────────┬────────────┘                             │
│                     │                                           │
├─────────────────────┼───────────────────────────────────────────┤
│                     ▼        MCI BOUNDARY                       │
│         ┌────────────────────────┐                             │
│         │    MCI Backend         │                             │
│         │  ┌──────────────────┐  │                             │
│         │  │ Kite Service     │  │                             │
│         │  │ Telemetry Routes │  │                             │
│         │  │ WebSocket Server │  │                             │
│         │  └──────────────────┘  │                             │
│         └───────────┬────────────┘                             │
│                     │                                           │
│                     ▼                                           │
│         ┌────────────────────────┐                             │
│         │    MCI Frontend        │                             │
│         │  ┌──────────────────┐  │                             │
│         │  │ Zustand Stores   │  │                             │
│         │  │ React Components │  │                             │
│         │  │ UXMI Library     │  │                             │
│         │  └──────────────────┘  │                             │
│         └───────────┬────────────┘                             │
│                     │                                           │
│                     ▼                                           │
│              ┌──────────────┐                                  │
│              │   Operator   │                                  │
│              └──────────────┘                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

*Document ID: FLOW-2.13-LIFECYCLE | Layer 2 Architecture | MCI Project*
