# 2.5 Shutdown Sequence Architecture
## 6-Step CR-002 Compliant Graceful Shutdown

**Node ID:** 2.5
**Category:** Backend
**CR Impact:** CR-002 (Graceful Shutdown) - SACRED
**Status:** CREATED
**Version:** 1.0
**Date:** 2026-01-27

---

## Purpose

This document defines the complete 6-step graceful shutdown protocol that is CONSTITUTIONALLY REQUIRED by CR-002. This is a SACRED requirement with no exceptions.

---

## CR-002 Definition

> **CR-002: Graceful Shutdown Protocol**
> All shutdowns must follow a 6-step sequence:
> 1. Cancel all pending orders
> 2. Close all positions
> 3. Disconnect from broker
> 4. Stop telemetry streams
> 5. Clear session state
> 6. Log shutdown complete

---

## Flow Diagram

```mermaid
flowchart TD
    subgraph TRIGGER["Shutdown Trigger"]
        A[User Clicks Shutdown] --> B{Shutdown Type?}
        B -->|Graceful| C[Start 6-Step Sequence]
        B -->|Emergency| D[Immediate Abort]
        D --> E[Skip to Step 6]
    end

    subgraph STEP_1["Step 1: Cancel Orders"]
        C --> F["Cancel All Pending Orders"]
        F --> G{Orders Canceled?}
        G -->|Yes| H[Step 1 Complete ✓]
        G -->|No| I[Retry 3x]
        I -->|Success| H
        I -->|Fail| J[Log Warning, Continue]
        J --> H
    end

    subgraph STEP_2["Step 2: Close Positions"]
        H --> K["Close All Open Positions"]
        K --> L{Positions Closed?}
        L -->|Yes| M[Step 2 Complete ✓]
        L -->|No| N[Retry 3x]
        N -->|Success| M
        N -->|Fail| O[Log Warning, Continue]
        O --> M
    end

    subgraph STEP_3["Step 3: Disconnect Broker"]
        M --> P["Disconnect from Broker API"]
        P --> Q{Disconnected?}
        Q -->|Yes| R[Step 3 Complete ✓]
        Q -->|No| S[Force Disconnect]
        S --> R
    end

    subgraph STEP_4["Step 4: Stop Telemetry"]
        R --> T["Stop All Telemetry Streams"]
        T --> U["Close WebSocket Connections"]
        U --> V[Step 4 Complete ✓]
    end

    subgraph STEP_5["Step 5: Clear Session"]
        V --> W["Clear Session State"]
        W --> X["Clear Token Store"]
        X --> Y["Clear Ignition Store"]
        Y --> Z["Clear Telemetry Store"]
        Z --> AA[Step 5 Complete ✓]
    end

    subgraph STEP_6["Step 6: Log Complete"]
        AA --> AB["Log Shutdown Complete"]
        E --> AB
        AB --> AC["Display Confirmation"]
        AC --> AD["Return to Phase 0"]
    end

    style TRIGGER fill:#ffcdd2
    style STEP_1 fill:#e3f2fd
    style STEP_2 fill:#fff3e0
    style STEP_3 fill:#e8f5e9
    style STEP_4 fill:#f3e5f5
    style STEP_5 fill:#fce4ec
    style STEP_6 fill:#e1f5fe
```

---

## Sequence Diagram

```mermaid
sequenceDiagram
    participant User
    participant UI as ShutdownPanel
    participant Store as shutdownStore
    participant API as /api/shutdown
    participant Engine as CIA-SIE-PURE
    participant Broker as Broker API

    User->>UI: Initiate Shutdown
    UI->>Store: setPhase('initiating')
    
    rect rgb(227, 242, 253)
        Note right of Store: Step 1: Cancel Orders
        Store->>API: POST /shutdown/step/1
        API->>Engine: cancelAllOrders()
        Engine->>Broker: Cancel Orders
        Broker-->>Engine: Confirmation
        API-->>Store: Step 1 Complete
    end

    rect rgb(255, 243, 224)
        Note right of Store: Step 2: Close Positions
        Store->>API: POST /shutdown/step/2
        API->>Engine: closeAllPositions()
        Engine->>Broker: Close Positions
        Broker-->>Engine: Confirmation
        API-->>Store: Step 2 Complete
    end

    rect rgb(232, 245, 233)
        Note right of Store: Step 3: Disconnect Broker
        Store->>API: POST /shutdown/step/3
        API->>Engine: disconnect()
        Engine->>Broker: Disconnect
        API-->>Store: Step 3 Complete
    end

    rect rgb(243, 229, 245)
        Note right of Store: Step 4: Stop Telemetry
        Store->>API: POST /shutdown/step/4
        API->>API: closeWebSockets()
        API-->>Store: Step 4 Complete
    end

    rect rgb(252, 228, 236)
        Note right of Store: Step 5: Clear Session
        Store->>Store: clearAllStores()
        Store-->>Store: Step 5 Complete
    end

    rect rgb(225, 245, 254)
        Note right of Store: Step 6: Log Complete
        Store->>API: POST /shutdown/complete
        API->>API: logShutdown()
        API-->>Store: Shutdown Complete
        Store-->>UI: Display Confirmation
        UI-->>User: Return to Phase 0
    end
```

---

## State Diagram

```mermaid
stateDiagram-v2
    [*] --> Running: Phase 3 Active
    Running --> Initiating: User Triggers Shutdown
    Initiating --> Step1: Begin Sequence
    Step1 --> Step2: Orders Canceled
    Step2 --> Step3: Positions Closed
    Step3 --> Step4: Broker Disconnected
    Step4 --> Step5: Telemetry Stopped
    Step5 --> Step6: Session Cleared
    Step6 --> Complete: Logged
    Complete --> [*]: Return to Phase 0

    Running --> Emergency: Emergency Shutdown
    Emergency --> Step6: Skip Steps 1-5
```

---

## Step Details

| Step | Action | Timeout | Retry | Fallback |
|------|--------|---------|-------|----------|
| 1 | Cancel all pending orders | 30s | 3x | Log warning, continue |
| 2 | Close all open positions | 60s | 3x | Log warning, continue |
| 3 | Disconnect from broker | 10s | 1x | Force disconnect |
| 4 | Stop telemetry streams | 5s | 0x | Force close |
| 5 | Clear session state | 1s | 0x | Force clear |
| 6 | Log shutdown complete | 1s | 0x | Log locally |

---

## Component Mapping

| Component | File | Responsibility |
|-----------|------|----------------|
| ShutdownPanel | `src/client/components/phase4/ShutdownPanel.tsx` | Shutdown UI |
| shutdownStore | `src/client/stores/shutdownStore.ts` | Shutdown state |
| shutdown route | `src/server/routes/shutdown.ts` | Shutdown execution |

---

## API Contract

### POST /api/shutdown

**Request:**
```json
{
  "type": "graceful" | "emergency"
}
```

**Response (Success):**
```json
{
  "success": true,
  "steps": [
    { "step": 1, "name": "Cancel Orders", "status": "complete", "duration": 2500 },
    { "step": 2, "name": "Close Positions", "status": "complete", "duration": 5200 },
    { "step": 3, "name": "Disconnect Broker", "status": "complete", "duration": 800 },
    { "step": 4, "name": "Stop Telemetry", "status": "complete", "duration": 200 },
    { "step": 5, "name": "Clear Session", "status": "complete", "duration": 50 },
    { "step": 6, "name": "Log Complete", "status": "complete", "duration": 100 }
  ],
  "totalDuration": 8850,
  "timestamp": 1706400000000
}
```

**Response (Error):**
```json
{
  "success": false,
  "failedStep": 2,
  "error": {
    "what": "Position close failed",
    "why": "Market closed for trading",
    "how": "Wait for market open or use emergency shutdown"
  },
  "partialSteps": [ /* completed steps */ ]
}
```

---

## Emergency vs Graceful

| Aspect | Graceful | Emergency |
|--------|----------|-----------|
| Steps Executed | All 6 | Only Step 6 |
| Orders | Canceled | Left as-is |
| Positions | Closed | Left open |
| Data Loss Risk | None | Possible |
| Use Case | Normal operation | System failure |
| User Confirmation | Required | Optional |

---

## Error Handling (CR-003)

| Scenario | WHAT | WHY | HOW |
|----------|------|-----|-----|
| Order Cancel Failed | Cannot cancel orders | Broker rejected request | Use emergency shutdown |
| Position Close Failed | Cannot close positions | Market closed or illiquid | Wait for market open |
| Broker Disconnect Failed | Connection stuck | Network issue | Force disconnect |
| Step Timeout | Step taking too long | Slow broker response | Skip step with warning |

---

## CR-002 Compliance Checklist

- [ ] All 6 steps executed in order
- [ ] Each step logged with timestamp
- [ ] Failures logged but don't block sequence
- [ ] Emergency path available
- [ ] Final confirmation displayed
- [ ] Session fully cleared before Phase 0

---

## Integration Points

| From | To | Protocol | Purpose |
|------|-----|----------|---------|
| ShutdownPanel | shutdownStore | Zustand | State management |
| shutdownStore | /api/shutdown | HTTP POST | Execute shutdown |
| /api/shutdown | CIA-SIE-PURE | Internal | Trading operations |
| /api/shutdown | Broker API | HTTPS | Cancel/close |
| shutdownStore | All Stores | Zustand | Clear state |

---

*Document ID: FLOW-2.5-SHUTDOWN | Layer 2 Architecture | MCI Project | CR-002 SACRED*
