# 2.2 Scanner Logic Architecture
## 12-Point Pre-Ignition Validation Sequence

**Node ID:** 2.2
**Category:** Backend
**CR Impact:** Phase 1 Validation
**Status:** CREATED
**Version:** 1.0
**Date:** 2026-01-27

---

## Purpose

This document defines the complete 12-point pre-ignition scanner that validates system readiness before engine ignition.

---

## Flow Diagram

```mermaid
flowchart TD
    subgraph TRIGGER["Scanner Trigger"]
        A[Phase 1 Entered] --> B[Auto-Start Scanner]
        B --> C[Initialize 12 Checks]
    end

    subgraph CHECKS["12-Point Validation"]
        C --> D1["1. Kite Connection"]
        C --> D2["2. API Key Valid"]
        C --> D3["3. Secret Valid"]
        C --> D4["4. Access Token Valid"]
        C --> D5["5. Token Not Expired"]
        C --> D6["6. Market Hours Check"]
        C --> D7["7. Backend Health"]
        C --> D8["8. WebSocket Ready"]
        C --> D9["9. Database Connection"]
        C --> D10["10. Memory Available"]
        C --> D11["11. CPU Available"]
        C --> D12["12. Network Latency OK"]
    end

    subgraph EXECUTION["Sequential Execution"]
        D1 --> E1{Pass?}
        E1 -->|Yes| D2
        E1 -->|No| F1[Mark Failed]
        
        D2 --> E2{Pass?}
        E2 -->|Yes| D3
        E2 -->|No| F2[Mark Failed]
        
        D12 --> E12{Pass?}
        E12 -->|Yes| G[All Passed]
        E12 -->|No| F12[Mark Failed]
    end

    subgraph RESULTS["Result Aggregation"]
        F1 & F2 & F12 --> H[Aggregate Failures]
        G --> I[All Checks Passed]
        H --> J{Critical Failures?}
        J -->|Yes| K[Block Ignition]
        J -->|No| L[Allow with Warnings]
        I --> M[Proceed to Phase 2]
    end

    style TRIGGER fill:#e3f2fd
    style CHECKS fill:#fff3e0
    style EXECUTION fill:#e8f5e9
    style RESULTS fill:#f3e5f5
```

---

## Sequence Diagram

```mermaid
sequenceDiagram
    participant UI as PreIgnitionScanner
    participant Store as scannerStore
    participant API as /api/scan
    participant Services as Backend Services
    participant Kite as Kite API

    UI->>Store: startScan()
    Store->>API: POST /api/scan

    loop For Each of 12 Checks
        API->>Services: Execute Check N
        Services->>Services: Validate
        alt Check Passes
            Services-->>API: {status: 'success'}
        else Check Fails
            Services-->>API: {status: 'failure', error}
        end
        API-->>Store: Update Check Status
        Store-->>UI: Re-render Check Item
    end

    API-->>Store: Final Results
    Store->>Store: Calculate canProceed
    Store-->>UI: Display Final Status
    
    alt All Critical Passed
        UI->>UI: Enable "Proceed" Button
    else Critical Failures
        UI->>UI: Display WHAT/WHY/HOW Errors
    end
```

---

## Check Definitions

| # | Check ID | Name | Category | Critical? | Timeout |
|---|----------|------|----------|-----------|---------|
| 1 | kite-connection | Kite API Connection | Network | YES | 5000ms |
| 2 | api-key-valid | API Key Validation | Auth | YES | 3000ms |
| 3 | secret-valid | API Secret Validation | Auth | YES | 3000ms |
| 4 | access-token | Access Token Valid | Auth | YES | 3000ms |
| 5 | token-expiry | Token Not Expired | Auth | YES | 100ms |
| 6 | market-hours | Market Hours Check | Business | NO | 100ms |
| 7 | backend-health | Backend Server Health | System | YES | 2000ms |
| 8 | websocket-ready | WebSocket Available | Network | NO | 3000ms |
| 9 | database-conn | Database Connection | System | NO | 3000ms |
| 10 | memory-check | Memory Available | Resources | NO | 100ms |
| 11 | cpu-check | CPU Available | Resources | NO | 100ms |
| 12 | network-latency | Network Latency < 100ms | Network | NO | 5000ms |

---

## State Diagram

```mermaid
stateDiagram-v2
    [*] --> Idle: Component Mount
    Idle --> Scanning: autoStart=true
    Idle --> Scanning: User Clicks Start
    
    Scanning --> CheckInProgress: Execute Check
    CheckInProgress --> CheckComplete: Check Finished
    CheckComplete --> Scanning: More Checks
    CheckComplete --> ResultsReady: All Complete
    
    ResultsReady --> AllPassed: No Failures
    ResultsReady --> SomeFailed: Has Failures
    
    AllPassed --> [*]: Proceed to Phase 2
    SomeFailed --> Idle: Retry
```

---

## Component Mapping

| Component | File | Responsibility |
|-----------|------|----------------|
| PreIgnitionScanner | `src/client/components/phase1/PreIgnitionScanner.tsx` | Orchestrates 12-point scan |
| ScanCheckItem | `src/client/components/phase1/ScanCheckItem.tsx` | Individual check display |
| scannerStore | `src/client/stores/scannerStore.ts` | Scanner state management |
| scan route | `src/server/routes/scan.ts` | Scan execution endpoint |

---

## API Contract

### POST /api/scan

**Request:**
```json
{
  "checks": ["all"] | ["check-id-1", "check-id-2"]
}
```

**Response:**
```json
{
  "checks": [
    {
      "id": "kite-connection",
      "name": "Kite API Connection",
      "status": "success" | "failure" | "warning",
      "duration": 245,
      "error": null | { "what": "", "why": "", "how": "" }
    }
  ],
  "summary": {
    "total": 12,
    "passed": 10,
    "failed": 1,
    "warnings": 1,
    "canProceed": true
  },
  "timestamp": 1706400000000
}
```

---

## Error Handling (CR-003)

| Check | Failure WHAT | WHY | HOW |
|-------|--------------|-----|-----|
| kite-connection | Cannot connect to Kite | Network issue or Kite down | Check internet, verify Kite status |
| api-key-valid | Invalid API Key | Key revoked or incorrect | Verify key in Kite Console |
| token-expiry | Token has expired | Past 6:00 AM IST | Return to Phase 0 for new token |
| backend-health | Backend not responding | Server crashed or not started | Restart backend server |
| websocket-ready | WebSocket unavailable | Port blocked or server issue | Check firewall, restart server |

---

## Integration Points

| From | To | Protocol | Purpose |
|------|-----|----------|---------|
| PreIgnitionScanner | scannerStore | Zustand | State management |
| scannerStore | /api/scan | HTTP POST | Execute checks |
| /api/scan | KiteService | Internal | Validate Kite connection |
| /api/scan | System | Internal | Check resources |

---

*Document ID: FLOW-2.2-SCANNER | Layer 2 Architecture | MCI Project*
