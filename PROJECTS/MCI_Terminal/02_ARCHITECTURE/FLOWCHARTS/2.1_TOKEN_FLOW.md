# 2.1 Token Flow Architecture
## Authentication Sequence: User Input → Kite Validation

**Node ID:** 2.1
**Category:** Backend
**CR Impact:** CR-001 (Token Validity), CR-004 (Token Expiry @ 6:00 AM IST), INV-006 (Input Sanitization)
**Status:** UPDATED
**Version:** 1.1
**Date:** 2026-01-28

---

## Purpose

This document defines the complete authentication flow for MCI, from initial user credential entry through Kite API validation and token state management.

---

## Flow Diagram

```mermaid
flowchart TD
    subgraph PHASE_0["Phase 0: Token Capture"]
        A[User Opens MCI] --> B[TokenCaptureForm Displayed]
        B --> C{Enter Credentials}
        C --> D[Kite API Key]
        C --> E[Kite Access Token]
        C --> F[Kite User ID]
    end

    subgraph SANITIZE_ENTRY["INV-006: Entry Point Sanitization"]
        D & E & F --> S1[sanitizeKiteCredentials]
        S1 --> S2{Valid Format?}
        S2 -->|Yes| S3[Trimmed & Validated]
        S2 -->|No| S4[Reject with Error]
        S4 --> B
    end

    subgraph VALIDATION["Token Validation"]
        S3 --> G[Submit to /api/auth/validate]
        G --> G1[sanitizeCredentialsFromRequest]
        G1 --> G2[buildKiteAuthHeader]
        G2 --> H{Kite API Call}
        H -->|Success| I[Access Token Received]
        H -->|Failure| J[Error: WHAT/WHY/HOW]
        J --> K[Display ErrorDisplay Component]
        K --> B
    end

    subgraph TOKEN_STATE["Token State Management - CR-004"]
        I --> L[Store in tokenStore]
        L --> M[Calculate Expiry]
        M --> N["Set to 6:00 AM IST Next Day"]
        N --> O[Start TokenTimer Countdown]
        O --> P{Time Remaining?}
        P -->|> 0| Q[Display Time in TokenTimer]
        P -->|<= 0| R[Token Expired - Return to Phase 0]
        R --> B
    end

    subgraph PHASE_TRANSITION["Phase Transition"]
        Q --> S{All Tokens Valid?}
        S -->|Yes| T[Proceed to Phase 1: Pre-Ignition Scan]
        S -->|No| B
    end

    style PHASE_0 fill:#e3f2fd
    style SANITIZE_ENTRY fill:#ffcdd2
    style VALIDATION fill:#fff3e0
    style TOKEN_STATE fill:#e8f5e9
    style PHASE_TRANSITION fill:#f3e5f5
```

---

## Sequence Diagram

```mermaid
sequenceDiagram
    participant User
    participant TokenCaptureForm
    participant Sanitizer as sanitize.ts (INV-006)
    participant tokenStore
    participant AuthRoute as /api/auth/validate
    participant KiteAPI as Zerodha Kite API

    User->>TokenCaptureForm: Enter credentials (may have whitespace)
    TokenCaptureForm->>Sanitizer: sanitizeKiteCredentials()
    
    alt Invalid Format
        Sanitizer-->>TokenCaptureForm: Throw Error
        TokenCaptureForm->>User: Display validation error
    else Valid Format
        Sanitizer-->>TokenCaptureForm: Sanitized credentials
        TokenCaptureForm->>tokenStore: setCredentials(sanitized)
        TokenCaptureForm->>AuthRoute: POST {sanitized credentials}
        AuthRoute->>Sanitizer: sanitizeCredentialsFromRequest()
        Sanitizer-->>AuthRoute: Re-sanitized credentials
        AuthRoute->>Sanitizer: buildKiteAuthHeader()
        Sanitizer-->>AuthRoute: Safe header value
        AuthRoute->>KiteAPI: Validate with clean header
        
        alt Valid Credentials
            KiteAPI-->>AuthRoute: 200 OK + Profile
            AuthRoute-->>TokenCaptureForm: {valid: true}
            tokenStore->>tokenStore: calculateExpiry(6:00 AM IST)
            TokenCaptureForm->>User: Success → Phase 1
        else Invalid Credentials
            KiteAPI-->>AuthRoute: Error Response
            AuthRoute-->>TokenCaptureForm: 401 Error
            TokenCaptureForm->>User: Display WHAT/WHY/HOW Error
        end
    end
```

---

## State Diagram

```mermaid
stateDiagram-v2
    [*] --> CheckStorage: App Start
    CheckStorage --> Rehydrate: localStorage has credentials
    CheckStorage --> NoToken: No stored credentials
    
    state Rehydrate {
        [*] --> Sanitize: INV-006 Defense
        Sanitize --> CheckExpiry: sanitizeString() each field
    }
    
    Rehydrate --> Active: Token still valid (now < expiresAt)
    Rehydrate --> NoToken: Token expired (now >= expiresAt) → Clear All
    NoToken --> Capturing: User Opens Form
    
    state Capturing {
        [*] --> UserInput
        UserInput --> FormSanitize: sanitizeKiteCredentials()
        FormSanitize --> [*]: Clean values
    }
    
    Capturing --> Validating: Submit Credentials
    
    state Validating {
        [*] --> APISanitize: sanitizeCredentialsFromRequest()
        APISanitize --> BuildHeader: buildKiteAuthHeader()
        BuildHeader --> KiteCall
        KiteCall --> [*]
    }
    
    Validating --> Valid: Kite Validates
    Validating --> Invalid: Kite Rejects
    Invalid --> Capturing: Retry
    Valid --> Active: Token Stored to localStorage
    Active --> Expired: 6:00 AM IST Passed
    Expired --> NoToken: Clear All Credentials
    Active --> Persisted: Browser/System Closed
    Persisted --> CheckStorage: Browser/System Reopened
```

### Daily Credential Continuity

**System Invariant INV-001:** Credentials persist across browser and system restarts within the daily validity window.

| Event | Behavior |
|-------|----------|
| Browser closed (token valid) | Credentials persist in localStorage |
| Browser reopened (token valid) | Credentials restored, session continues |
| Browser reopened (token expired) | Credentials cleared, forced re-authentication |
| System reboot (token valid) | Credentials persist and restore |
| 6:00 AM IST reached | All credentials forcibly cleared |

---

## Component Mapping

| Component | File | Responsibility |
|-----------|------|----------------|
| TokenCaptureForm | `src/client/components/phase0/TokenCaptureForm.tsx` | Credential input UI |
| TokenTimer | `src/client/components/phase0/TokenTimer.tsx` | Expiry countdown display |
| CredentialsHelper | `src/client/components/phase0/CredentialsHelper.tsx` | Credential reference |
| tokenStore | `src/client/stores/tokenStore.ts` | Token state management |
| auth route | `src/server/routes/auth.ts` | Validation endpoint |
| **sanitize module** | `src/shared/validation/sanitize.ts` | **INV-006 centralized sanitization** |

---

## INV-006 Sanitization Points

```
User Input → [SANITIZE #1] → tokenStore → localStorage
                                             ↓
                                       App Restart
                                             ↓
                           localStorage → [SANITIZE #2] → tokenStore
                                             ↓
                                       API Request
                                             ↓
           Request Body → [SANITIZE #3] → buildKiteAuthHeader → Kite API
```

| Point | Function | Location | Purpose |
|-------|----------|----------|---------|
| SANITIZE #1 | `sanitizeKiteCredentials()` | TokenCaptureForm | Entry point sanitization |
| SANITIZE #2 | `sanitizeString()` | tokenStore merge | Rehydration sanitization |
| SANITIZE #3 | `sanitizeCredentialsFromRequest()` + `buildKiteAuthHeader()` | auth route | API boundary sanitization |

---

## CR Compliance Verification

### CR-001: Token Validity Check
- **Requirement:** Every operation must validate the token before execution
- **Implementation:** `tokenStore.isExpired` checked before any API call
- **Evidence:** `src/client/stores/tokenStore.ts` lines 15-25

### CR-004: Token Expiry @ 6:00 AM IST
- **Requirement:** Kite tokens expire daily at 6:00 AM IST (00:30 UTC)
- **Implementation:** `calculateExpiry()` function sets expiry to next 6:00 AM IST
- **Evidence:** `src/client/stores/tokenStore.ts` lines 30-45

### INV-006: Input Sanitization & Boundary Cleanliness
- **Requirement:** All externally supplied inputs sanitized at point of entry; all API boundaries sanitize regardless of upstream guarantees
- **Implementation:** Centralized `sanitize.ts` module with defense-in-depth at 3 points
- **Evidence:** 
  - Entry: `src/client/components/phase0/TokenCaptureForm.tsx` calls `sanitizeKiteCredentials()`
  - Rehydration: `src/client/stores/tokenStore.ts` merge function calls `sanitizeString()`
  - API: `src/server/routes/auth.ts` calls `sanitizeCredentialsFromRequest()` + `buildKiteAuthHeader()`

---

## Error Handling (CR-003)

| Error Scenario | WHAT | WHY | HOW |
|----------------|------|-----|-----|
| Invalid API Key | Authentication failed | API key is incorrect or expired | Verify API key in Kite Console |
| Invalid Secret | Authentication failed | API secret doesn't match key | Re-generate secret in Kite Console |
| Invalid Request Token | Session creation failed | Request token expired or used | Get new request token from Kite login |
| Network Error | Connection failed | Cannot reach Kite API | Check internet connection |

---

## Integration Points

| Integration | Protocol | Contract |
|-------------|----------|----------|
| Frontend → Backend | HTTP POST | `/api/auth/validate` |
| Backend → Kite | HTTPS | Kite Connect REST API |
| Store → Components | Zustand | `useTokenStore()` hook |

---

*Document ID: FLOW-2.1-TOKEN | Layer 2 Architecture | MCI Project*
