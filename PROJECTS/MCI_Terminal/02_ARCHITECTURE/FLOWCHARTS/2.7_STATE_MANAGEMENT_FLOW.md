# 2.7 State Management Flow Architecture
## Zustand Store Interactions and Data Flow

**Node ID:** 2.7
**Category:** Frontend
**CR Impact:** All Stores
**Status:** CREATED
**Version:** 1.0
**Date:** 2026-01-27

---

## Purpose

This document defines the complete Zustand state management architecture, including store definitions, inter-store relationships, and data flow patterns.

---

## Store Overview

```mermaid
graph TD
    subgraph STORES["Zustand Stores"]
        A[tokenStore] --> B["CR-001, CR-004"]
        C[scannerStore] --> D["Phase 1"]
        E[ignitionStore] --> F["Phase 2"]
        G[telemetryStore] --> H["Phase 3"]
        I[shutdownStore] --> J["CR-002"]
    end

    subgraph SHARED["Shared State"]
        K[Phase Progression]
        L[Error State]
    end

    A --> K
    C --> K
    E --> K
    I --> K

    A --> L
    C --> L
    E --> L
    I --> L

    style STORES fill:#e3f2fd
    style SHARED fill:#fff3e0
```

---

## Store Definitions

### tokenStore (CR-001, CR-004)

```mermaid
classDiagram
    class TokenStore {
        +string apiKey
        +string apiSecret
        +string requestToken
        +string accessToken
        +number expiresAt
        +boolean isValid
        +setCredentials(key, secret, token)
        +setAccessToken(token)
        +clearTokens()
        +isExpired(): boolean
        +timeRemaining(): number
    }
```

### scannerStore

```mermaid
classDiagram
    class ScannerStore {
        +ScanCheck[] checks
        +string status
        +boolean canProceed
        +startScan()
        +updateCheck(id, status, error?)
        +reset()
    }

    class ScanCheck {
        +string id
        +string name
        +string status
        +ErrorDetails error
    }
```

### ignitionStore

```mermaid
classDiagram
    class IgnitionStore {
        +string phase
        +string selectedBackend
        +BackendConfig[] backendConfigs
        +setPhase(phase)
        +setSelectedBackend(backend)
        +reset()
    }

    class BackendConfig {
        +string type
        +string name
        +string icon
        +boolean available
    }
```

### telemetryStore

```mermaid
classDiagram
    class TelemetryStore {
        +boolean isConnected
        +Position[] positions
        +Order[] orders
        +AccountMetrics account
        +SystemHealth health
        +MarketData[] marketData
        +ActivityLog[] activityLog
        +setConnected(connected)
        +updatePositions(positions)
        +updateOrders(orders)
        +updateAccount(account)
        +updateHealth(health)
        +updateMarketData(data)
        +addActivity(activity)
        +reset()
    }
```

### shutdownStore (CR-002)

```mermaid
classDiagram
    class ShutdownStore {
        +string phase
        +number currentStep
        +ShutdownStep[] steps
        +setPhase(phase)
        +completeStep(step)
        +reset()
    }

    class ShutdownStep {
        +number step
        +string name
        +string status
        +number duration
    }
```

---

## Inter-Store Data Flow

```mermaid
flowchart LR
    subgraph PHASE_FLOW["Phase Progression"]
        T[tokenStore] -->|Valid Token| S[scannerStore]
        S -->|All Passed| I[ignitionStore]
        I -->|Running| L[telemetryStore]
        L -->|Shutdown| D[shutdownStore]
        D -->|Complete| T
    end

    style PHASE_FLOW fill:#e8f5e9
```

---

## Store State Lifecycle

```mermaid
stateDiagram-v2
    [*] --> TokenCapture: App Start
    
    state TokenCapture {
        [*] --> NoToken
        NoToken --> Capturing: Enter Credentials
        Capturing --> Valid: Validation Success
        Capturing --> NoToken: Validation Failed
        Valid --> Expired: 6:00 AM IST
        Expired --> NoToken
    }

    TokenCapture --> PreIgnition: Token Valid

    state PreIgnition {
        [*] --> Idle
        Idle --> Scanning: Start Scan
        Scanning --> Complete: All Checks Done
        Complete --> Passed: Can Proceed
        Complete --> Failed: Cannot Proceed
        Failed --> Idle: Retry
    }

    PreIgnition --> Ignition: Scan Passed

    state Ignition {
        [*] --> SelectBackend
        SelectBackend --> Armed: Click ARM
        Armed --> Igniting: Click IGNITE
        Armed --> SelectBackend: Timeout
        Igniting --> Running: Success
        Igniting --> SelectBackend: Failed
    }

    Ignition --> Telemetry: Running

    state Telemetry {
        [*] --> Connecting
        Connecting --> Connected: WS Open
        Connected --> Streaming: Data Flowing
        Streaming --> Connected: Pause
        Connected --> Disconnected: Lost
    }

    Telemetry --> Shutdown: User Request

    state Shutdown {
        [*] --> Step1
        Step1 --> Step2
        Step2 --> Step3
        Step3 --> Step4
        Step4 --> Step5
        Step5 --> Step6
        Step6 --> Complete
    }

    Shutdown --> TokenCapture: Complete
```

---

## Component-Store Bindings

| Component | Store | Hook | Actions Used |
|-----------|-------|------|--------------|
| TokenCaptureForm | tokenStore | useTokenStore | setCredentials, setAccessToken |
| TokenTimer | tokenStore | useTokenStore | isExpired, timeRemaining |
| PreIgnitionScanner | scannerStore | useScannerStore | startScan, updateCheck |
| BackendSelector | ignitionStore | useIgnitionStore | setSelectedBackend |
| IgnitionButton | ignitionStore | useIgnitionStore | setPhase |
| TelemetryDashboard | telemetryStore | useTelemetryStore | setConnected |
| PositionsPanel | telemetryStore | useTelemetryStore | positions |
| OrdersPanel | telemetryStore | useTelemetryStore | orders |
| AccountPanel | telemetryStore | useTelemetryStore | account |
| SystemHealthPanel | telemetryStore | useTelemetryStore | health |
| MarketDataPanel | telemetryStore | useTelemetryStore | marketData |
| ShutdownPanel | shutdownStore | useShutdownStore | setPhase, completeStep |

---

## State Persistence

| Store | Persistence | Mechanism |
|-------|-------------|-----------|
| tokenStore | Daily (until 6:00 AM IST) | localStorage with CR-004 enforcement |
| scannerStore | None | In-memory only |
| ignitionStore | Session | sessionStorage |
| telemetryStore | None | In-memory only |
| shutdownStore | None | In-memory only |

### Daily Credential Continuity (System Invariant)

**INV-001: Daily Credential Persistence**

The tokenStore implements daily credential continuity as a system invariant:

```
┌─────────────────────────────────────────────────────────────────────────┐
│  INVARIANT: DAILY CREDENTIAL CONTINUITY                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. Credentials persist in localStorage across browser/system restarts │
│  2. Persistence is BOUNDED to tokenExpiresAt (6:00 AM IST)             │
│  3. On rehydration: if now >= tokenExpiresAt → ALL credentials cleared │
│  4. No backend persistence — credentials remain client-side only        │
│  5. No silent renewal — expiry forces re-authentication                 │
│                                                                         │
│  This invariant is NON-NEGOTIABLE and requires Principal approval       │
│  for any modification.                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Verification Points:**
- `tokenStore.ts` line 263: `storage: createJSONStorage(() => localStorage)`
- `tokenStore.ts` lines 280-298: CR-004 enforcement on rehydration
- `tokenStore.ts` lines 264-272: Credentials included in `partialize`

---

## Error State Pattern

All stores follow a consistent error pattern:

```typescript
interface ErrorState {
  hasError: boolean;
  error: {
    what: string;   // What happened
    why: string;    // Why it happened
    how: string;    // How to fix it
  } | null;
}
```

---

## Store Reset Flow

```mermaid
flowchart TD
    A[Full Reset Triggered] --> B[shutdownStore.reset]
    B --> C[telemetryStore.reset]
    C --> D[ignitionStore.reset]
    D --> E[scannerStore.reset]
    E --> F[tokenStore.clearTokens]
    F --> G[App → Phase 0]

    style A fill:#ffcdd2
    style G fill:#c8e6c9
```

---

## Performance Considerations

| Optimization | Implementation |
|--------------|----------------|
| Selective subscriptions | Components subscribe only to needed slices |
| Shallow comparisons | Zustand default prevents unnecessary re-renders |
| Memoized selectors | Used for derived state |
| Batched updates | Multiple state changes in single action |

---

*Document ID: FLOW-2.7-STATE | Layer 2 Architecture | MCI Project*
