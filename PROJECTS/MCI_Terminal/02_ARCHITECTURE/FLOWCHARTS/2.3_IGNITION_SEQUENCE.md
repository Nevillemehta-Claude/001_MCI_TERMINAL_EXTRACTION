# 2.3 Ignition Sequence Architecture
## Engine Start Sequence with Safety Gates

**Node ID:** 2.3
**Category:** Backend
**CR Impact:** Phase 2 Validation
**Status:** CREATED
**Version:** 1.0
**Date:** 2026-01-27

---

## Purpose

This document defines the two-stage ignition sequence that safely starts the trading engine, including backend selection and safety gate validation.

---

## Flow Diagram

```mermaid
flowchart TD
    subgraph PHASE_2["Phase 2: Ignition"]
        A[Phase 2 Entered] --> B[Display BackendSelector]
        B --> C{Select Backend}
        C --> D["Zerodha Kite (Default)"]
        C --> E["ICICI Direct"]
        C --> F["HDFC Sky"]
        C --> G["Kotak Neo"]
    end

    subgraph STAGE_1["Stage 1: Arm System"]
        D & E & F & G --> H[Backend Selected]
        H --> I[IgnitionButton Displayed]
        I --> J{First Click: ARM}
        J --> K[System Armed]
        K --> L[Button Changes to IGNITE]
        L --> M[5s Countdown Starts]
    end

    subgraph STAGE_2["Stage 2: Ignite"]
        M --> N{Second Click: IGNITE}
        N -->|Within 5s| O[Execute Ignition]
        N -->|Timeout| P[Disarm - Return to Stage 1]
        P --> I
    end

    subgraph IGNITION_EXEC["Ignition Execution"]
        O --> Q[POST /api/ignition]
        Q --> R{Backend Validation}
        R -->|Valid| S[Start Engine Connection]
        R -->|Invalid| T[Error: Backend Unavailable]
        S --> U[Initialize WebSocket]
        U --> V[Start Telemetry Stream]
        V --> W[Phase 3: Running]
        T --> X[Display WHAT/WHY/HOW Error]
        X --> I
    end

    style PHASE_2 fill:#e3f2fd
    style STAGE_1 fill:#fff3e0
    style STAGE_2 fill:#e8f5e9
    style IGNITION_EXEC fill:#f3e5f5
```

---

## Sequence Diagram

```mermaid
sequenceDiagram
    participant User
    participant BackendSelector
    participant IgnitionButton
    participant Store as ignitionStore
    participant API as /api/ignition
    participant Engine as CIA-SIE-PURE

    User->>BackendSelector: Select Broker
    BackendSelector->>Store: setSelectedBackend()
    
    User->>IgnitionButton: Click ARM
    IgnitionButton->>Store: setPhase('armed')
    IgnitionButton->>IgnitionButton: Start 5s Timer
    
    User->>IgnitionButton: Click IGNITE (within 5s)
    IgnitionButton->>Store: setPhase('igniting')
    IgnitionButton->>API: POST {backend: 'zerodha'}
    
    API->>Engine: Connect to Backend
    
    alt Connection Success
        Engine-->>API: Connection Established
        API-->>Store: setPhase('running')
        Store-->>IgnitionButton: Success
        Note over User: Transition to Phase 3
    else Connection Failed
        Engine-->>API: Error
        API-->>Store: setPhase('idle')
        Store-->>IgnitionButton: Error (WHAT/WHY/HOW)
    end
```

---

## Two-Stage Safety Gate

```mermaid
stateDiagram-v2
    [*] --> Idle: Phase 2 Entry
    Idle --> BackendSelected: Select Backend
    BackendSelected --> Armed: Click ARM
    Armed --> Igniting: Click IGNITE (< 5s)
    Armed --> Idle: Timeout (5s)
    Igniting --> Running: Success
    Igniting --> Idle: Failure
    Running --> [*]: Phase 3 Active
```

### Why Two Stages?

| Stage | Purpose | Safety Gate |
|-------|---------|-------------|
| ARM | Prepare system, confirm intent | Prevents accidental ignition |
| IGNITE | Execute connection | Timeout forces re-confirmation |

---

## Backend Configurations

| Backend ID | Display Name | Icon | API Endpoint | Status |
|------------|--------------|------|--------------|--------|
| zerodha | Zerodha Kite | ü™Å | api.kite.trade | Primary |
| icici | ICICI Direct | üè¶ | api.icicidirect.com | Supported |
| hdfc | HDFC Sky | üå§Ô∏è | api.hdfcsky.com | Supported |
| kotak | Kotak Neo | üèõÔ∏è | api.kotaksecurities.com | Supported |

---

## Component Mapping

| Component | File | Responsibility |
|-----------|------|----------------|
| BackendSelector | `src/client/components/phase2/BackendSelector.tsx` | Backend selection UI |
| IgnitionButton | `src/client/components/phase2/IgnitionButton.tsx` | Two-stage ignition control |
| ignitionStore | `src/client/stores/ignitionStore.ts` | Ignition state management |
| ignition route | `src/server/routes/ignition.ts` | Ignition execution endpoint |

---

## API Contract

### POST /api/ignition

**Request:**
```json
{
  "backend": "zerodha" | "icici" | "hdfc" | "kotak"
}
```

**Response (Success):**
```json
{
  "success": true,
  "backend": "zerodha",
  "connectionId": "conn-abc123",
  "websocketUrl": "wss://...",
  "timestamp": 1706400000000
}
```

**Response (Error):**
```json
{
  "success": false,
  "error": {
    "what": "Ignition failed",
    "why": "Backend service unavailable",
    "how": "Contact broker support or try again later"
  }
}
```

---

## Error Handling (CR-003)

| Scenario | WHAT | WHY | HOW |
|----------|------|-----|-----|
| Backend Unavailable | Ignition failed | Broker API not responding | Check broker status, try later |
| Token Expired During Ignition | Session invalid | Token expired at 6:00 AM IST | Return to Phase 0 |
| Network Timeout | Connection timeout | Slow network or firewall | Check network, retry |
| Rate Limited | Too many requests | Exceeded API rate limit | Wait 60 seconds, retry |

---

## Safety Constraints

1. **Pre-Ignition Scan Must Pass**: Cannot enter Phase 2 without Phase 1 completion
2. **Token Must Be Valid**: CR-001 checked before ignition
3. **Two-Stage Confirmation**: Prevents accidental activation
4. **5-Second Timeout**: Forces conscious decision
5. **Single Backend**: Only one backend can be active at a time

---

## Integration Points

| From | To | Protocol | Purpose |
|------|-----|----------|---------|
| BackendSelector | ignitionStore | Zustand | Backend selection |
| IgnitionButton | ignitionStore | Zustand | Phase state |
| ignitionStore | /api/ignition | HTTP POST | Execute ignition |
| /api/ignition | Broker API | HTTPS | Establish connection |
| /api/ignition | WebSocket | WSS | Initialize telemetry |

---

*Document ID: FLOW-2.3-IGNITION | Layer 2 Architecture | MCI Project*
