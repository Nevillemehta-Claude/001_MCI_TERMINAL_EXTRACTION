# PAD-GH1 WORKFLOW 4 — AUTOPILOT-GRADE REPEATABILITY STRESS
# Authority: PAD-GH1 — Independent GitHub Verification
# Standard: NASA / IV&V / Autopilot-Grade
# Purpose: Prove determinism under repetition

name: PAD-GH1 Repeatability Stress

on:
  workflow_dispatch:
    inputs:
      cycles:
        description: 'Number of full end-to-end cycles'
        required: false
        default: '10'
  push:
    branches: [main]
    paths:
      - '.github/workflows/pad-gh1-stress.yml'

env:
  BUN_VERSION: '1.0.30'

jobs:
  repeatability-stress:
    name: Repeatability & Determinism Stress Test
    runs-on: ubuntu-latest
    
    outputs:
      total_cycles: ${{ steps.summary.outputs.total_cycles }}
      passed_cycles: ${{ steps.summary.outputs.passed_cycles }}
      determinism_cv: ${{ steps.summary.outputs.cv }}
      worst_case: ${{ steps.summary.outputs.worst_case }}
      verdict: ${{ steps.summary.outputs.verdict }}

    steps:
      # ═══════════════════════════════════════════════════════════════
      # PHASE 1: SETUP
      # ═══════════════════════════════════════════════════════════════
      - name: Display Header
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "PAD-GH1 WORKFLOW 4 — AUTOPILOT-GRADE REPEATABILITY STRESS"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "Execution Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Runner: ${{ runner.os }}"
          echo "Cycles: ${{ github.event.inputs.cycles || '10' }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # ═══════════════════════════════════════════════════════════════
      # PHASE 2: FULL E2E CYCLES WITH RESTART
      # ═══════════════════════════════════════════════════════════════
      - name: Execute Stress Cycles
        id: stress
        run: |
          CYCLES=${{ github.event.inputs.cycles || '10' }}
          echo "Executing $CYCLES full end-to-end cycles with forced restarts..."
          echo ""
          
          DURATIONS=""
          PASS_COUNT=0
          FAIL_COUNT=0
          TEST_COUNTS=""
          
          for i in $(seq 1 $CYCLES); do
            echo ""
            echo "╔═══════════════════════════════════════════════════════════════╗"
            echo "║  CYCLE $i / $CYCLES"
            echo "╚═══════════════════════════════════════════════════════════════╝"
            
            # Forced restart: Clear any cached state
            echo "→ Clearing cached state..."
            rm -rf .cache 2>/dev/null || true
            rm -rf node_modules/.cache 2>/dev/null || true
            
            # Optional: Simulate latency (add delay)
            if [ $((i % 3)) -eq 0 ]; then
              echo "→ Injecting 2s latency..."
              sleep 2
            fi
            
            # Execute full test suite
            echo "→ Running full test suite..."
            START_TIME=$(date +%s.%N)
            
            if bun run test 2>&1 | tee "stress-cycle-$i.log"; then
              END_TIME=$(date +%s.%N)
              DURATION=$(echo "$END_TIME - $START_TIME" | bc)
              DURATIONS="$DURATIONS $DURATION"
              
              # Extract test count
              TESTS=$(grep -oP '\d+(?= passed)' "stress-cycle-$i.log" | tail -1 || echo "0")
              TEST_COUNTS="$TEST_COUNTS $TESTS"
              
              PASS_COUNT=$((PASS_COUNT + 1))
              echo ""
              echo "✅ Cycle $i: PASS"
              echo "   Tests: $TESTS"
              echo "   Duration: ${DURATION}s"
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo ""
              echo "❌ Cycle $i: FAIL"
            fi
            
            # Brief pause between cycles
            sleep 1
          done
          
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "STRESS TEST COMPLETE"
          echo "═══════════════════════════════════════════════════════════════"
          
          echo "cycles_pass=$PASS_COUNT" >> $GITHUB_OUTPUT
          echo "cycles_fail=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "cycles_total=$CYCLES" >> $GITHUB_OUTPUT
          
          # Calculate statistics
          if [ $PASS_COUNT -gt 1 ]; then
            # Duration statistics
            MEAN=$(echo $DURATIONS | tr ' ' '\n' | grep -v '^$' | awk '{sum+=$1} END {print sum/NR}')
            MIN=$(echo $DURATIONS | tr ' ' '\n' | grep -v '^$' | sort -n | head -1)
            MAX=$(echo $DURATIONS | tr ' ' '\n' | grep -v '^$' | sort -n | tail -1)
            STDDEV=$(echo $DURATIONS | tr ' ' '\n' | grep -v '^$' | awk -v mean=$MEAN '{sum+=($1-mean)^2} END {print sqrt(sum/NR)}')
            CV=$(echo "scale=2; ($STDDEV / $MEAN) * 100" | bc 2>/dev/null || echo "0")
            
            echo "duration_mean=$MEAN" >> $GITHUB_OUTPUT
            echo "duration_min=$MIN" >> $GITHUB_OUTPUT
            echo "duration_max=$MAX" >> $GITHUB_OUTPUT
            echo "duration_stddev=$STDDEV" >> $GITHUB_OUTPUT
            echo "duration_cv=$CV" >> $GITHUB_OUTPUT
            
            # Test count consistency
            UNIQUE_COUNTS=$(echo $TEST_COUNTS | tr ' ' '\n' | grep -v '^$' | sort -u | wc -l)
            if [ "$UNIQUE_COUNTS" = "1" ]; then
              echo "test_consistency=CONSISTENT" >> $GITHUB_OUTPUT
            else
              echo "test_consistency=INCONSISTENT" >> $GITHUB_OUTPUT
            fi
            
            echo ""
            echo "Duration Statistics:"
            echo "  Mean:   ${MEAN}s"
            echo "  Min:    ${MIN}s"
            echo "  Max:    ${MAX}s"
            echo "  StdDev: ${STDDEV}s"
            echo "  CV:     ${CV}%"
            echo ""
            echo "Test Consistency: $UNIQUE_COUNTS unique count(s)"
          fi
          
          if [ $FAIL_COUNT -gt 0 ]; then
            echo ""
            echo "❌ STRESS TEST FAILED: $FAIL_COUNT cycles failed"
            exit 1
          fi

      # ═══════════════════════════════════════════════════════════════
      # PHASE 3: FAILURE INJECTION (Safe)
      # ═══════════════════════════════════════════════════════════════
      - name: Safe Failure Injection Test
        id: failure_injection
        run: |
          echo "Testing system resilience to invalid inputs..."
          
          # Test 1: Invalid API call (should be handled gracefully)
          echo "→ Testing invalid API handling..."
          
          # Run a subset of tests multiple times rapidly
          RAPID_PASS=0
          for i in {1..5}; do
            if bun run test --silent 2>&1 | tail -3; then
              RAPID_PASS=$((RAPID_PASS + 1))
            fi
          done
          
          if [ $RAPID_PASS -eq 5 ]; then
            echo "✅ Rapid execution test: PASS ($RAPID_PASS/5)"
            echo "status=PASS" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Rapid execution test: DEGRADED ($RAPID_PASS/5)"
            echo "status=DEGRADED" >> $GITHUB_OUTPUT
          fi

      # ═══════════════════════════════════════════════════════════════
      # PHASE 4: SUMMARY
      # ═══════════════════════════════════════════════════════════════
      - name: Generate Summary
        id: summary
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "REPEATABILITY & DETERMINISM SUMMARY"
          echo "═══════════════════════════════════════════════════════════════"
          
          CYCLES_PASS="${{ steps.stress.outputs.cycles_pass }}"
          CYCLES_TOTAL="${{ steps.stress.outputs.cycles_total }}"
          CV="${{ steps.stress.outputs.duration_cv }}"
          MAX="${{ steps.stress.outputs.duration_max }}"
          
          echo "total_cycles=$CYCLES_TOTAL" >> $GITHUB_OUTPUT
          echo "passed_cycles=$CYCLES_PASS" >> $GITHUB_OUTPUT
          echo "cv=$CV" >> $GITHUB_OUTPUT
          echo "worst_case=$MAX" >> $GITHUB_OUTPUT
          
          # Determine verdict
          if [ "$CYCLES_PASS" = "$CYCLES_TOTAL" ]; then
            # Check CV threshold (< 15% is acceptable)
            CV_INT=$(echo "$CV" | cut -d. -f1)
            if [ -z "$CV_INT" ] || [ "$CV_INT" -lt 15 ]; then
              echo "verdict=DETERMINISTIC" >> $GITHUB_OUTPUT
              VERDICT="✅ DETERMINISTIC"
            else
              echo "verdict=HIGH_VARIANCE" >> $GITHUB_OUTPUT
              VERDICT="⚠️ HIGH VARIANCE"
            fi
          else
            echo "verdict=NONDETERMINISTIC" >> $GITHUB_OUTPUT
            VERDICT="❌ NONDETERMINISTIC"
          fi
          
          echo ""
          echo "┌─────────────────────────────────────────────────────────────┐"
          echo "│  VERDICT: $VERDICT"
          echo "├─────────────────────────────────────────────────────────────┤"
          echo "│  Cycles Passed:       $CYCLES_PASS / $CYCLES_TOTAL"
          echo "│  Duration CV:         ${CV}%"
          echo "│  Worst Case:          ${MAX}s"
          echo "│  Test Consistency:    ${{ steps.stress.outputs.test_consistency }}"
          echo "│  Failure Injection:   ${{ steps.failure_injection.outputs.status }}"
          echo "└─────────────────────────────────────────────────────────────┘"

      # ═══════════════════════════════════════════════════════════════
      # PHASE 5: ARTIFACT
      # ═══════════════════════════════════════════════════════════════
      - name: Generate Report
        run: |
          cat > GH_REPEATABILITY_AND_DETERMINISM_REPORT.md << EOF
          # GH_REPEATABILITY_AND_DETERMINISM_REPORT
          
          **Authority:** PAD-GH1 — Independent GitHub Verification
          **Workflow:** Repeatability Stress
          **Execution Time:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Runner:** ${{ runner.os }}
          
          ---
          
          ## STRESS TEST RESULTS
          
          | Metric | Value |
          |--------|-------|
          | Total Cycles | ${{ steps.stress.outputs.cycles_total }} |
          | Passed Cycles | ${{ steps.stress.outputs.cycles_pass }} |
          | Failed Cycles | ${{ steps.stress.outputs.cycles_fail }} |
          | Pass Rate | $(echo "scale=1; ${{ steps.stress.outputs.cycles_pass }} * 100 / ${{ steps.stress.outputs.cycles_total }}" | bc)% |
          
          ---
          
          ## VARIANCE ANALYSIS
          
          | Metric | Value |
          |--------|-------|
          | Mean Duration | ${{ steps.stress.outputs.duration_mean }}s |
          | Min Duration | ${{ steps.stress.outputs.duration_min }}s |
          | Max Duration | ${{ steps.stress.outputs.duration_max }}s |
          | Std Deviation | ${{ steps.stress.outputs.duration_stddev }}s |
          | Coefficient of Variation | ${{ steps.stress.outputs.duration_cv }}% |
          
          ---
          
          ## CONSISTENCY CHECK
          
          | Check | Result |
          |-------|--------|
          | Test Count Consistency | ${{ steps.stress.outputs.test_consistency }} |
          | Failure Injection | ${{ steps.failure_injection.outputs.status }} |
          
          ---
          
          ## VERDICT
          
          **${{ steps.summary.outputs.verdict }}**
          
          ---
          
          *Generated by PAD-GH1 Workflow 4*
          EOF

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: GH_REPEATABILITY_AND_DETERMINISM_REPORT
          path: GH_REPEATABILITY_AND_DETERMINISM_REPORT.md
          retention-days: 90

      - name: Upload Cycle Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stress-cycle-logs
          path: stress-cycle-*.log
          retention-days: 30
