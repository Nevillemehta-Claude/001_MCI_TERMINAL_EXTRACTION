# PAD-GH1 WORKFLOW 1 — MCI INDEPENDENT CERTIFICATION
# Authority: PAD-GH1 — Independent GitHub Verification
# Standard: NASA / IV&V / Autopilot-Grade
# Purpose: Prove MCI is correct in total isolation

name: PAD-GH1 MCI Independent Certification

on:
  workflow_dispatch:
    inputs:
      cycles:
        description: 'Number of repeated test cycles'
        required: false
        default: '10'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - '.github/workflows/pad-gh1-mci-independent.yml'

env:
  BUN_VERSION: '1.0.30'
  NODE_VERSION: '20'

jobs:
  mci-independent-certification:
    name: MCI Independent Certification
    runs-on: ubuntu-latest
    
    outputs:
      total_tests: ${{ steps.summary.outputs.total_tests }}
      total_passed: ${{ steps.summary.outputs.total_passed }}
      total_failed: ${{ steps.summary.outputs.total_failed }}
      cycles_completed: ${{ steps.summary.outputs.cycles_completed }}
      determinism_cv: ${{ steps.summary.outputs.determinism_cv }}
      verdict: ${{ steps.summary.outputs.verdict }}

    steps:
      # ═══════════════════════════════════════════════════════════════
      # PHASE 1: CLEAN CHECKOUT (No Cache, No Assumptions)
      # ═══════════════════════════════════════════════════════════════
      - name: Clean Checkout
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1

      - name: Verify Clean State
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "PAD-GH1 WORKFLOW 1 — MCI INDEPENDENT CERTIFICATION"
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "Execution Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Runner: ${{ runner.os }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Verifying clean state..."
          if [ -d "node_modules" ]; then
            echo "ERROR: node_modules exists before install"
            exit 1
          fi
          echo "✅ Clean state verified"

      # ═══════════════════════════════════════════════════════════════
      # PHASE 2: ENVIRONMENT SETUP (Fresh Install)
      # ═══════════════════════════════════════════════════════════════
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node (for npm compatibility)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Fresh Dependency Install
        run: |
          echo "Installing dependencies from scratch..."
          bun install --frozen-lockfile
          echo "✅ Dependencies installed"
          echo ""
          echo "Dependency count: $(ls node_modules | wc -l) packages"

      # ═══════════════════════════════════════════════════════════════
      # PHASE 3: TYPE CHECKING
      # ═══════════════════════════════════════════════════════════════
      - name: TypeScript Type Check
        id: typecheck
        run: |
          echo "Running TypeScript type check..."
          if bun run typecheck 2>&1 | tee typecheck.log; then
            echo "typecheck_status=PASS" >> $GITHUB_OUTPUT
            echo "✅ Type check passed"
          else
            echo "typecheck_status=FAIL" >> $GITHUB_OUTPUT
            echo "❌ Type check failed"
            # Don't exit - continue to gather full evidence
          fi

      # ═══════════════════════════════════════════════════════════════
      # PHASE 4: SINGLE TEST RUN (Baseline)
      # ═══════════════════════════════════════════════════════════════
      - name: Baseline Test Run
        id: baseline
        run: |
          echo "Running baseline test suite..."
          START_TIME=$(date +%s.%N)
          
          if bun run test 2>&1 | tee baseline-test.log; then
            END_TIME=$(date +%s.%N)
            DURATION=$(echo "$END_TIME - $START_TIME" | bc)
            
            # Extract test counts
            TESTS=$(grep -oP '\d+(?= passed)' baseline-test.log | tail -1 || echo "0")
            FILES=$(grep -oP '\d+(?= test files)' baseline-test.log | tail -1 || echo "0")
            
            echo "baseline_status=PASS" >> $GITHUB_OUTPUT
            echo "baseline_tests=$TESTS" >> $GITHUB_OUTPUT
            echo "baseline_duration=$DURATION" >> $GITHUB_OUTPUT
            
            echo "✅ Baseline: $TESTS tests passed in ${DURATION}s"
          else
            echo "baseline_status=FAIL" >> $GITHUB_OUTPUT
            echo "❌ Baseline test run failed"
            exit 1
          fi

      # ═══════════════════════════════════════════════════════════════
      # PHASE 5: REPEATED EXECUTION (Determinism Verification)
      # ═══════════════════════════════════════════════════════════════
      - name: Repeated Test Cycles
        id: repeated
        run: |
          CYCLES=${{ github.event.inputs.cycles || '10' }}
          echo "Running $CYCLES repeated test cycles..."
          echo ""
          
          DURATIONS=""
          PASS_COUNT=0
          FAIL_COUNT=0
          
          for i in $(seq 1 $CYCLES); do
            echo "═══ Cycle $i/$CYCLES ═══"
            START_TIME=$(date +%s.%N)
            
            if bun run test --silent 2>&1 | tee "cycle-$i.log"; then
              END_TIME=$(date +%s.%N)
              DURATION=$(echo "$END_TIME - $START_TIME" | bc)
              DURATIONS="$DURATIONS $DURATION"
              PASS_COUNT=$((PASS_COUNT + 1))
              echo "✅ Cycle $i: PASS (${DURATION}s)"
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "❌ Cycle $i: FAIL"
            fi
          done
          
          echo ""
          echo "cycles_pass=$PASS_COUNT" >> $GITHUB_OUTPUT
          echo "cycles_fail=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "cycles_total=$CYCLES" >> $GITHUB_OUTPUT
          
          # Calculate variance
          if [ $PASS_COUNT -gt 1 ]; then
            # Calculate mean and standard deviation
            MEAN=$(echo $DURATIONS | tr ' ' '\n' | awk '{sum+=$1} END {print sum/NR}')
            STDDEV=$(echo $DURATIONS | tr ' ' '\n' | awk -v mean=$MEAN '{sum+=($1-mean)^2} END {print sqrt(sum/NR)}')
            CV=$(echo "scale=2; ($STDDEV / $MEAN) * 100" | bc)
            echo "duration_cv=$CV" >> $GITHUB_OUTPUT
            echo ""
            echo "Duration Statistics:"
            echo "  Mean: ${MEAN}s"
            echo "  StdDev: ${STDDEV}s"
            echo "  CV: ${CV}%"
          fi
          
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "❌ $FAIL_COUNT cycles failed - NONDETERMINISTIC BEHAVIOR DETECTED"
            exit 1
          fi
          
          echo ""
          echo "✅ All $CYCLES cycles passed - DETERMINISTIC"

      # ═══════════════════════════════════════════════════════════════
      # PHASE 6: BUILD VERIFICATION
      # ═══════════════════════════════════════════════════════════════
      - name: Build Verification
        id: build
        run: |
          echo "Running production build..."
          if bun run build 2>&1 | tee build.log; then
            if [ -d "dist" ]; then
              SIZE=$(du -sh dist | cut -f1)
              echo "build_status=PASS" >> $GITHUB_OUTPUT
              echo "build_size=$SIZE" >> $GITHUB_OUTPUT
              echo "✅ Build successful: $SIZE"
            else
              echo "build_status=FAIL" >> $GITHUB_OUTPUT
              echo "❌ Build failed: dist directory not created"
              exit 1
            fi
          else
            echo "build_status=FAIL" >> $GITHUB_OUTPUT
            echo "❌ Build command failed"
            exit 1
          fi

      # ═══════════════════════════════════════════════════════════════
      # PHASE 7: SUMMARY & VERDICT
      # ═══════════════════════════════════════════════════════════════
      - name: Generate Summary
        id: summary
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "MCI INDEPENDENT CERTIFICATION SUMMARY"
          echo "═══════════════════════════════════════════════════════════════"
          
          BASELINE_TESTS="${{ steps.baseline.outputs.baseline_tests }}"
          CYCLES_PASS="${{ steps.repeated.outputs.cycles_pass }}"
          CYCLES_TOTAL="${{ steps.repeated.outputs.cycles_total }}"
          CV="${{ steps.repeated.outputs.duration_cv }}"
          
          TOTAL_TESTS=$((BASELINE_TESTS * CYCLES_TOTAL))
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "total_passed=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "total_failed=0" >> $GITHUB_OUTPUT
          echo "cycles_completed=$CYCLES_TOTAL" >> $GITHUB_OUTPUT
          echo "determinism_cv=$CV" >> $GITHUB_OUTPUT
          
          # Determine verdict
          if [ "$CYCLES_PASS" = "$CYCLES_TOTAL" ]; then
            echo "verdict=CERTIFIED" >> $GITHUB_OUTPUT
            VERDICT="✅ CERTIFIED"
          else
            echo "verdict=FAILED" >> $GITHUB_OUTPUT
            VERDICT="❌ FAILED"
          fi
          
          echo ""
          echo "┌─────────────────────────────────────────────────────────────┐"
          echo "│  VERDICT: $VERDICT"
          echo "├─────────────────────────────────────────────────────────────┤"
          echo "│  Tests per cycle:    $BASELINE_TESTS"
          echo "│  Cycles completed:   $CYCLES_PASS / $CYCLES_TOTAL"
          echo "│  Total tests run:    $TOTAL_TESTS"
          echo "│  Determinism CV:     ${CV}%"
          echo "│  Build status:       ${{ steps.build.outputs.build_status }}"
          echo "│  TypeCheck status:   ${{ steps.typecheck.outputs.typecheck_status }}"
          echo "└─────────────────────────────────────────────────────────────┘"

      # ═══════════════════════════════════════════════════════════════
      # PHASE 8: ARTIFACT GENERATION
      # ═══════════════════════════════════════════════════════════════
      - name: Generate Certification Report
        run: |
          cat > GH_MCI_INDEPENDENT_CERTIFICATION_REPORT.md << 'EOF'
          # GH_MCI_INDEPENDENT_CERTIFICATION_REPORT
          
          **Authority:** PAD-GH1 — Independent GitHub Verification
          **Workflow:** MCI Independent Certification
          **Execution Time:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Commit:** ${{ github.sha }}
          **Runner:** ${{ runner.os }}
          
          ---
          
          ## EXECUTION SUMMARY
          
          | Metric | Value |
          |--------|-------|
          | Tests per cycle | ${{ steps.baseline.outputs.baseline_tests }} |
          | Cycles executed | ${{ steps.repeated.outputs.cycles_total }} |
          | Cycles passed | ${{ steps.repeated.outputs.cycles_pass }} |
          | Cycles failed | ${{ steps.repeated.outputs.cycles_fail }} |
          | Total tests run | ${{ steps.summary.outputs.total_tests }} |
          | Determinism CV | ${{ steps.repeated.outputs.duration_cv }}% |
          | Build status | ${{ steps.build.outputs.build_status }} |
          | TypeCheck status | ${{ steps.typecheck.outputs.typecheck_status }} |
          
          ---
          
          ## VERDICT
          
          **${{ steps.summary.outputs.verdict }}**
          
          ---
          
          ## EVIDENCE
          
          - All tests executed on fresh GitHub runner
          - No cached dependencies used
          - No environment-specific assumptions
          - Results reproducible by any third party
          
          ---
          
          *Generated by PAD-GH1 Workflow 1*
          EOF
          
          echo "✅ Report generated: GH_MCI_INDEPENDENT_CERTIFICATION_REPORT.md"

      - name: Upload Certification Report
        uses: actions/upload-artifact@v4
        with:
          name: GH_MCI_INDEPENDENT_CERTIFICATION_REPORT
          path: GH_MCI_INDEPENDENT_CERTIFICATION_REPORT.md
          retention-days: 90

      - name: Upload Test Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mci-test-logs
          path: |
            *.log
            cycle-*.log
          retention-days: 30
